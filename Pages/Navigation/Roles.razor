@page "/roles"
@using EyeHospitalPOS.Models
@using EyeHospitalPOS.Helper
@using EyeHospitalPOS.Data
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject LoginManager LoginManager
@inject NavigationManager Navigation

@attribute [Authorize(Roles = "Administrator,Manager")]

<PageTitle>Roles & Permissions - Eye Hospital POS</PageTitle>

<div class="page-container p-4">
        <!-- Unified Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
             <div>
                <h3 class="mb-1 fw-bold">Roles & Permissions Management</h3>
                <p class="text-muted tiny mb-0">Manage roles, permissions, and user access</p>
             </div>
             <div class="d-flex gap-2">
                 <div class="d-flex align-items-center me-3">
                     <DxCheckBox Checked="@showInactiveRoles" 
                                 CheckedChanged="@(async (bool val) => { showInactiveRoles = val; await LoadRoles(); })" />
                     <span class="ms-2 tiny text-muted">Show Deactivated</span>
                 </div>
                 <DxButton Text="New Role"
                           RenderStyle="ButtonRenderStyle.Primary"
                           IconCssClass="fa-solid fa-plus"
                           CssClass="premium-btn"
                           Click="@(() => Navigation.NavigateTo("/roles/new"))" />
             </div>
        </div>

        @if (showError)
        {
            <div class="alert alert-danger mb-4">@errorMessage</div>
        }

        @if (showSuccess)
        {
            <div class="alert alert-success mb-4">@successMessage</div>
        }

        <!-- Tabs -->
        <DxTabs @bind-ActiveTabIndex="@ActiveTabIndex" CssClass="mb-3">
            <DxTabPage Text="Roles" IconCssClass="fa-solid fa-user-shield">
                <div class="premium-card overflow-hidden">
                    <div class="card-body p-0">
                        <DxGrid @ref="Grid"
                                Data="@roles"
                                KeyFieldName="Id"
                                ShowFilterRow="false"
                                ShowSearchBox="true"
                                PageSize="20"
                                CssClass="enterprise-grid"
                                DataItemDeleting="OnDataItemDeleting">
                            <Columns>
                                <DxGridDataColumn FieldName="Name" Caption="Role Name" MinWidth="200" />
                                <DxGridDataColumn FieldName="Description" Caption="Description" MinWidth="250" />
                                <DxGridDataColumn FieldName="ParentRoleId" Caption="Parent Role" Width="180px">
                                    <CellDisplayTemplate>
                                        @{
                                            var role = (Role)context.DataItem;
                                            var parentRole = roles.FirstOrDefault(r => r.Id == role.ParentRoleId);
                                        }
                                        @if (parentRole != null)
                                        {
                                            <span class="badge bg-info tiny">@parentRole.Name</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted tiny">No Parent</span>
                                        }
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                                <DxGridDataColumn FieldName="IsAdministrative" Caption="Administrative" Width="120px" HeaderCssClass="text-center" CssClass="text-center">
                                    <CellDisplayTemplate>
                                        <span class='trend-badge @((bool)context.Value ? "positive" : "neutral")' style="width: 100px; justify-content: center;">
                                            @((bool)context.Value ? "FULL ACCESS" : "LIMITED")
                                        </span>
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                                <DxGridDataColumn FieldName="CanEditModel" Caption="Can Edit Data" Width="120px" HeaderCssClass="text-center" CssClass="text-center">
                                    <CellDisplayTemplate>
                                        <i class='fa-solid @((bool)context.Value ? "fa-circle-check text-success" : "fa-circle-xmark text-muted")'></i>
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                                <DxGridDataColumn FieldName="IsActive" Caption="Status" Width="100px" HeaderCssClass="text-center" CssClass="text-center">
                                    <CellDisplayTemplate>
                                        <span class='trend-badge @((bool)context.Value ? "positive" : "negative")' style="width: 80px; justify-content: center;">
                                            @((bool)context.Value ? "ACTIVE" : "INACTIVE")
                                        </span>
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                                 <DxGridDataColumn Caption="Actions" Width="280px" TextAlignment="GridTextAlignment.Center">
                                    <CellDisplayTemplate>
                                        <div class="d-flex gap-2 justify-content-center">
                                             <DxButton Text="Edit"
                                                       RenderStyle="ButtonRenderStyle.Secondary" 
                                                       IconCssClass="fa-solid fa-pen-to-square"
                                                       SizeMode="SizeMode.Small"
                                                       CssClass="px-2"
                                                       Click="@(() => Navigation.NavigateTo($"/roles/edit/{(context.DataItem as Role).Id}"))" />
                                            <DxButton Text="Pages"
                                                      RenderStyle="ButtonRenderStyle.Info"
                                                      IconCssClass="fa-solid fa-file-shield"
                                                      SizeMode="SizeMode.Small"
                                                      CssClass="px-2"
                                                      Click="@(async () => {
                                                          var role = (Role)context.DataItem;
                                                          selectedRole = role;
                                                          await LoadPagePermissionsForRole(role);
                                                          ShowPagePermissionsModal = true;
                                                      })" />
                                            <DxButton Text="Perms"
                                                      RenderStyle="ButtonRenderStyle.Warning"
                                                      IconCssClass="fa-solid fa-key"
                                                      SizeMode="SizeMode.Small"
                                                      CssClass="px-2"
                                                      Click="@(async () => {
                                                          var role = (Role)context.DataItem;
                                                          selectedRole = role;
                                                          await LoadPermissionsForRole(role);
                                                          ShowPermissionsModal = true;
                                                      })" />
                                             <DxButton RenderStyle="ButtonRenderStyle.Danger" 
                                                       IconCssClass="fa-solid fa-trash"
                                                       SizeMode="SizeMode.Small"
                                                       Click="@(() => Grid.ShowDataItemDeleteConfirmation(context.DataItem))" />
                                        </div>
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                            </Columns>
                        </DxGrid>
                    </div>
                </div>
            </DxTabPage>

            <DxTabPage Text="Child Roles" IconCssClass="fa-solid fa-sitemap">
                <div class="premium-card">
                    <div class="card-body">
                        <h5 class="mb-3">Role Hierarchy</h5>
                        <p class="text-muted mb-4">View and manage parent-child role relationships</p>
                        
                        @foreach (var parentRole in roles.Where(r => r.ParentRoleId == null))
                        {
                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fa-solid fa-crown text-warning me-2"></i>
                                    <strong>@parentRole.Name</strong>
                                    <span class="badge bg-primary ms-2 tiny">Parent Role</span>
                                </div>
                                
                                @{
                                    var childRoles = roles.Where(r => r.ParentRoleId == parentRole.Id).ToList();
                                }
                                
                                @if (childRoles.Any())
                                {
                                    <div class="ms-4">
                                        @foreach (var childRole in childRoles)
                                        {
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fa-solid fa-arrow-right text-muted me-2"></i>
                                                <span>@childRole.Name</span>
                                                <span class="badge bg-info ms-2 tiny">Child Role</span>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="ms-4 text-muted tiny">No child roles</div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </DxTabPage>

            <DxTabPage Text="User Access" IconCssClass="fa-solid fa-users-gear">
                <div class="premium-card">
                    <div class="card-body">
                        <h5 class="mb-3">Assign Roles to Users</h5>
                        <p class="text-muted mb-4">Manage user role assignments</p>
                        
                        <DxGrid Data="@users"
                                KeyFieldName="Id"
                                ShowFilterRow="false"
                                ShowSearchBox="true"
                                PageSize="15"
                                CssClass="enterprise-grid">
                            <Columns>
                                <DxGridDataColumn FieldName="UserName" Caption="Username" MinWidth="150" />
                                <DxGridDataColumn FieldName="Email" Caption="Email" MinWidth="200" />
                                <DxGridDataColumn FieldName="RoleId" Caption="Current Role" Width="200px">
                                    <CellDisplayTemplate>
                                        @{
                                            var user = (User)context.DataItem;
                                            var userRole = roles.FirstOrDefault(r => r.Id == user.RoleId);
                                        }
                                        @if (userRole != null)
                                        {
                                            <span class="badge bg-success">@userRole.Name</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">No Role</span>
                                        }
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                                <DxGridDataColumn FieldName="IsActive" Caption="Status" Width="100px" HeaderCssClass="text-center" CssClass="text-center">
                                    <CellDisplayTemplate>
                                        <span class='badge @((bool)context.Value ? "bg-success" : "bg-danger") tiny'>
                                            @((bool)context.Value ? "Active" : "Inactive")
                                        </span>
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                                <DxGridDataColumn Caption="Actions" Width="150px" TextAlignment="GridTextAlignment.Center">
                                    <CellDisplayTemplate>
                                        <DxButton Text="Assign Role"
                                                  RenderStyle="ButtonRenderStyle.Primary"
                                                  IconCssClass="fa-solid fa-user-tag"
                                                  SizeMode="SizeMode.Small"
                                                  Click="@(() => {
                                                      selectedUser = (User)context.DataItem;
                                                      selectedRoleIdForUser = selectedUser.RoleId;
                                                      ShowUserRoleModal = true;
                                                  })" />
                                    </CellDisplayTemplate>
                                </DxGridDataColumn>
                            </Columns>
                        </DxGrid>
                    </div>
                </div>
            </DxTabPage>
        </DxTabs>
    </div>

    <!-- Page Permissions Modal -->
    <DxPopup @bind-Visible="@ShowPagePermissionsModal"
             HeaderText="@($"Page Permissions for {selectedRole?.Name}")"
             Width="900px"
             Height="700px"
             ShowCloseButton="true">
        <BodyContentTemplate>
            <div class="p-3">
                @if (selectedRole != null && pagePermissions.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Page/Object</th>
                                    <th class="text-center">Read</th>
                                    <th class="text-center">Write</th>
                                    <th class="text-center">Create</th>
                                    <th class="text-center">Delete</th>
                                    <th class="text-center">Navigate</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var module in pagePermissions.GroupBy(p => p.Module))
                                {
                                    <tr class="table-secondary">
                                        <td colspan="6"><strong><i class="fa-solid fa-folder me-2"></i>@module.Key</strong></td>
                                    </tr>
                                    @foreach (var page in module)
                                    {
                                        <tr>
                                            <td>@(page.PageName)</td>
                                            <td class="text-center">
                                                <DxCheckBox @bind-Checked="@GetOrCreateRolePagePermission(page.Id).CanRead" />
                                            </td>
                                            <td class="text-center">
                                                <DxCheckBox @bind-Checked="@GetOrCreateRolePagePermission(page.Id).CanWrite" />
                                            </td>
                                            <td class="text-center">
                                                <DxCheckBox @bind-Checked="@GetOrCreateRolePagePermission(page.Id).CanCreate" />
                                            </td>
                                            <td class="text-center">
                                                <DxCheckBox @bind-Checked="@GetOrCreateRolePagePermission(page.Id).CanDelete" />
                                            </td>
                                            <td class="text-center">
                                                <DxCheckBox @bind-Checked="@GetOrCreateRolePagePermission(page.Id).CanNavigate" />
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </BodyContentTemplate>
        <FooterTemplate>
             <div class="d-flex justify-content-between p-3 border-top bg-light w-100">
                <DxButton Text="Close" RenderStyle="ButtonRenderStyle.Secondary" Click="@(() => ShowPagePermissionsModal = false)" />
                <DxButton Text="Save Page Permissions" RenderStyle="ButtonRenderStyle.Primary" IconCssClass="fa-solid fa-check" Click="@SavePagePermissions" />
            </div>
        </FooterTemplate>
    </DxPopup>

    <!-- Module Permissions Modal -->
    <DxPopup @bind-Visible="@ShowPermissionsModal"
             HeaderText="@($"Module Permissions for {selectedRole?.Name}")"
             Width="800px"
             Height="600px"
             ShowCloseButton="true">
        <BodyContentTemplate>
            <div class="p-3">
                @if (selectedRole != null)
                {
                    <DxFormLayout Data="@permissionModel" ItemSpacing="10px" CaptionPosition="CaptionPosition.Vertical" Context="formContext">
                        <DxFormLayoutGroup ColSpanLg="12">
                            <!-- POS Permissions -->
                            <DxFormLayoutItem Caption="POS & Sales Actions" ColSpanLg="12" Context="itemContext">
                                <div class="border p-3 rounded mb-3 bg-light">
                                    <h6 class="border-bottom pb-2 mb-3 fw-bold text-primary"><i class="fa-solid fa-cash-register me-2"></i>Point of Sale</h6>
                                    <div class="row g-3">
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanAccessPOS">Access POS</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanProcessSales">Process Sales</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanVoidSales">Void Transactions</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanRefundSales">Process Refunds</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanEditPrices">Edit Prices</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanOverrideDiscounts">Override Discounts</DxCheckBox></div>
                                    </div>
                                </div>
                            </DxFormLayoutItem>
                            
                            <!-- Inventory Permissions -->
                            <DxFormLayoutItem Caption="Inventory Management" ColSpanLg="12" Context="itemContext">
                                <div class="border p-3 rounded mb-3 bg-light">
                                    <h6 class="border-bottom pb-2 mb-3 fw-bold text-success"><i class="fa-solid fa-boxes-stacked me-2"></i>Inventory</h6>
                                    <div class="row g-3">
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanAccessInventory">Access Inventory</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanReceiveInventory">Receive Stock</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanCreatePurchaseOrders">Create POs</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanAdjustInventory">Adjust Stock</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanViewInventoryReports">View Reports</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanEditInventory">Manage Items</DxCheckBox></div>
                                    </div>
                                </div>
                            </DxFormLayoutItem>
                            
                            <!-- System Permissions -->
                            <DxFormLayoutItem Caption="System Administration" ColSpanLg="12" Context="itemContext">
                                <div class="border p-3 rounded mb-3 bg-light">
                                    <h6 class="border-bottom pb-2 mb-3 fw-bold text-danger"><i class="fa-solid fa-gears me-2"></i>System</h6>
                                    <div class="row g-3">
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanManageUsers">Manage Users</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanManageRoles">Manage Roles</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanViewSystemReports">View Analytics</DxCheckBox></div>
                                        <div class="col-md-4"><DxCheckBox @bind-Checked="@permissionModel.CanManageSuppliers">Manage Suppliers</DxCheckBox></div>
                                    </div>
                                </div>
                            </DxFormLayoutItem>
                        </DxFormLayoutGroup>
                    </DxFormLayout>
                }
            </div>
        </BodyContentTemplate>
        <FooterTemplate>
             <div class="d-flex justify-content-between p-3 border-top bg-light w-100">
                <DxButton Text="Close" RenderStyle="ButtonRenderStyle.Secondary" Click="@(() => ShowPermissionsModal = false)" />
                <DxButton Text="Save Module Permissions" RenderStyle="ButtonRenderStyle.Primary" IconCssClass="fa-solid fa-check" Click="@SavePermissions" />
            </div>
        </FooterTemplate>
    </DxPopup>

    <!-- User Role Assignment Modal -->
    <DxPopup @bind-Visible="@ShowUserRoleModal"
             HeaderText="@($"Assign Role to {selectedUser?.UserName}")"
             Width="500px"
             ShowCloseButton="true">
        <BodyContentTemplate>
            <div class="p-3">
                @if (selectedUser != null)
                {
                    <DxFormLayout>
                        <DxFormLayoutItem Caption="Username" ColSpanLg="12">
                            <Template Context="usernameContext">
                                <strong>@selectedUser.UserName</strong>
                            </Template>
                        </DxFormLayoutItem>
                        <DxFormLayoutItem Caption="Email" ColSpanLg="12">
                            <Template Context="emailContext">
                                @selectedUser.Email
                            </Template>
                        </DxFormLayoutItem>
                        <DxFormLayoutItem Caption="Select Role" ColSpanLg="12">
                            <Template Context="roleContext">
                                <DxComboBox Data="@roles.Where(r => r.IsActive)"
                                            @bind-Value="@selectedRoleIdForUser"
                                            TextFieldName="Name"
                                            ValueFieldName="Id"
                                            AllowUserInput="false"
                                            ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto">
                                </DxComboBox>
                            </Template>
                        </DxFormLayoutItem>
                    </DxFormLayout>
                }
            </div>
        </BodyContentTemplate>
        <FooterTemplate>
             <div class="d-flex justify-content-between p-3 border-top bg-light w-100">
                <DxButton Text="Cancel" RenderStyle="ButtonRenderStyle.Secondary" Click="@(() => ShowUserRoleModal = false)" />
                <DxButton Text="Assign Role" RenderStyle="ButtonRenderStyle.Primary" IconCssClass="fa-solid fa-check" Click="@AssignRoleToUser" />
            </div>
        </FooterTemplate>
    </DxPopup>

@code {
    private List<Role> roles = new List<Role>();
    private List<User> users = new List<User>();
    private List<PagePermission> pagePermissions = new List<PagePermission>();
    private List<RolePagePermission> rolePagePermissions = new List<RolePagePermission>();
    
    private DxGrid Grid { get; set; }
    private bool showError = false;
    private bool showSuccess = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    
    private bool ShowPermissionsModal = false;
    private bool ShowPagePermissionsModal = false;
    private bool ShowUserRoleModal = false;
    
    private Role? selectedRole = null;
    private User? selectedUser = null;
    private string selectedRoleIdForUser = string.Empty;
    
    private PermissionModel permissionModel = new();
    private int ActiveTabIndex = 0;

    protected override async Task OnInitializedAsync()
    {
        // await LoadData();
        // Skip manual check as [Authorize] handles it.
        // If we need LoginManager to be ready, we can wait for initialization in the UI or let the state provider handle it.
        await LoadData();
    }

    private async Task LoadData()
    {
        await LoadRoles();
        await LoadUsers();
        await LoadPagePermissions();
    }

    private bool showInactiveRoles = false;

    private async Task LoadRoles()
    {
        var query = DbContext.Roles
            .Include(r => r.RolePermissions)
            .Include(r => r.RolePagePermissions)
            .AsNoTracking();

        if (!showInactiveRoles)
        {
            query = query.Where(r => r.IsActive);
        }

        roles = await query.ToListAsync();
    }

    private async Task LoadUsers()
    {
        users = await DbContext.Users
            .Include(u => u.Role)
            .AsNoTracking()
            .ToListAsync();
    }

    private async Task LoadPagePermissions()
    {
        pagePermissions = await DbContext.PagePermissions
            .Where(p => p.IsActive)
            .OrderBy(p => p.Module)
            .ThenBy(p => p.PageName)
            .AsNoTracking()
            .ToListAsync();
    }

    private async Task OnDataItemDeleting(GridDataItemDeletingEventArgs e)
    {
        try
        {
            var dataItem = (Role)e.DataItem;
            
            // Perform checks with AsNoTracking to avoid adding them to context
            var usersInRole = await DbContext.Users.AsNoTracking().AnyAsync(u => u.RoleId == dataItem.Id);
            if (usersInRole)
            {
                errorMessage = "Cannot delete role because it is assigned to users.";
                showError = true;
                showSuccess = false;
                e.Cancel = true;
                return;
            }

            var hasChildRoles = await DbContext.Roles.AsNoTracking().AnyAsync(r => r.ParentRoleId == dataItem.Id);
            if (hasChildRoles)
            {
                errorMessage = "Cannot delete role because it has child roles.";
                showError = true;
                showSuccess = false;
                e.Cancel = true;
                return;
            }

            // Safely handle tracking conflicts for soft deletion
            var trackedRole = await DbContext.Roles.FindAsync(dataItem.Id);
            if (trackedRole != null)
            {
                trackedRole.IsActive = false; // Soft delete
                await DbContext.SaveChangesAsync();
                
                // Clear the context's state for this item to prevent downstream tracking issues
                DbContext.Entry(trackedRole).State = EntityState.Detached;

                await LoadRoles();
                showError = false;
                showSuccess = true;
                successMessage = "Role deactivated successfully!";
            }
            else
            {
                errorMessage = "Role not found.";
                showError = true;
                showSuccess = false;
                e.Cancel = true;
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error deleting role: " + ex.Message;
            showError = true;
            showSuccess = false;
            e.Cancel = true;
        }
    }

    private async Task LoadPermissionsForRole(Role role)
    {
        if (role == null) return;

        // Load existing permissions for the role
        var rolePermissions = await DbContext.RolePermissions
            .Where(rp => rp.RoleId == role.Id)
            .ToListAsync();

        // Map to permission model
        permissionModel = new PermissionModel
        {
            CanAccessPOS = rolePermissions.Any(rp => rp.PermissionName == "POS.Access"),
            CanProcessSales = rolePermissions.Any(rp => rp.PermissionName == "POS.ProcessSales"),
            CanVoidSales = rolePermissions.Any(rp => rp.PermissionName == "POS.VoidSales"),
            CanRefundSales = rolePermissions.Any(rp => rp.PermissionName == "POS.RefundSales"),
            CanEditPrices = rolePermissions.Any(rp => rp.PermissionName == "POS.EditPrices"),
            CanOverrideDiscounts = rolePermissions.Any(rp => rp.PermissionName == "POS.OverrideDiscounts"),
            CanAccessInventory = rolePermissions.Any(rp => rp.PermissionName == "Inventory.Access"),
            CanEditInventory = rolePermissions.Any(rp => rp.PermissionName == "Inventory.Edit"),
            CanReceiveInventory = rolePermissions.Any(rp => rp.PermissionName == "Inventory.Receive"),
            CanAdjustInventory = rolePermissions.Any(rp => rp.PermissionName == "Inventory.Adjust"),
            CanViewInventoryReports = rolePermissions.Any(rp => rp.PermissionName == "Inventory.ViewReports"),
            CanCreatePurchaseOrders = rolePermissions.Any(rp => rp.PermissionName == "Inventory.CreatePurchaseOrders"),
            CanAccessSales = rolePermissions.Any(rp => rp.PermissionName == "Sales.Access"),
            CanViewSalesReports = rolePermissions.Any(rp => rp.PermissionName == "Sales.ViewReports"),
            CanViewSalesHistory = rolePermissions.Any(rp => rp.PermissionName == "Sales.ViewHistory"),
            CanManageCustomers = rolePermissions.Any(rp => rp.PermissionName == "Sales.ManageCustomers"),
            CanManageUsers = rolePermissions.Any(rp => rp.PermissionName == "System.ManageUsers"),
            CanManageRoles = rolePermissions.Any(rp => rp.PermissionName == "System.ManageRoles"),
            CanManageProducts = rolePermissions.Any(rp => rp.PermissionName == "System.ManageProducts"),
            CanManageSuppliers = rolePermissions.Any(rp => rp.PermissionName == "System.ManageSuppliers"),
            CanViewSystemReports = rolePermissions.Any(rp => rp.PermissionName == "System.ViewReports")
        };
    }

    private async Task LoadPagePermissionsForRole(Role role)
    {
        if (role == null) return;

        // Load existing page permissions for the role
        rolePagePermissions = await DbContext.RolePagePermissions
            .Where(rpp => rpp.RoleId == role.Id)
            .ToListAsync();
    }

    private async Task SavePermissions()
    {
        if (selectedRole == null) return;

        try
        {
            // Get existing permissions for this role
            var existingPermissions = await DbContext.RolePermissions
                .Where(rp => rp.RoleId == selectedRole.Id)
                .ToListAsync();

            // Remove all existing permissions for this role
            DbContext.RolePermissions.RemoveRange(existingPermissions);

            // Add new permissions based on the permission model
            var newPermissions = new List<RolePermission>();

            if (permissionModel.CanAccessPOS)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "POS.Access", Module = "POS" });
            if (permissionModel.CanProcessSales)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "POS.ProcessSales", Module = "POS" });
            if (permissionModel.CanVoidSales)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "POS.VoidSales", Module = "POS" });
            if (permissionModel.CanRefundSales)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "POS.RefundSales", Module = "POS" });
            if (permissionModel.CanEditPrices)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "POS.EditPrices", Module = "POS" });
            if (permissionModel.CanOverrideDiscounts)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "POS.OverrideDiscounts", Module = "POS" });
            if (permissionModel.CanAccessInventory)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Inventory.Access", Module = "Inventory" });
            if (permissionModel.CanEditInventory)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Inventory.Edit", Module = "Inventory" });
            if (permissionModel.CanReceiveInventory)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Inventory.Receive", Module = "Inventory" });
            if (permissionModel.CanAdjustInventory)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Inventory.Adjust", Module = "Inventory" });
            if (permissionModel.CanViewInventoryReports)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Inventory.ViewReports", Module = "Inventory" });
            if (permissionModel.CanCreatePurchaseOrders)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Inventory.CreatePurchaseOrders", Module = "Inventory" });
            if (permissionModel.CanAccessSales)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Sales.Access", Module = "Sales" });
            if (permissionModel.CanViewSalesReports)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Sales.ViewReports", Module = "Sales" });
            if (permissionModel.CanViewSalesHistory)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Sales.ViewHistory", Module = "Sales" });
            if (permissionModel.CanManageCustomers)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "Sales.ManageCustomers", Module = "Sales" });
            if (permissionModel.CanManageUsers)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "System.ManageUsers", Module = "System" });
            if (permissionModel.CanManageRoles)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "System.ManageRoles", Module = "System" });
            if (permissionModel.CanManageProducts)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "System.ManageProducts", Module = "System" });
            if (permissionModel.CanManageSuppliers)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "System.ManageSuppliers", Module = "System" });
            if (permissionModel.CanViewSystemReports)
                newPermissions.Add(new RolePermission { RoleId = selectedRole.Id, PermissionName = "System.ViewReports", Module = "System" });

            if (newPermissions.Any())
            {
                await DbContext.RolePermissions.AddRangeAsync(newPermissions);
            }

            await DbContext.SaveChangesAsync();
            
            ShowPermissionsModal = false;
            await LoadRoles();
            
            showSuccess = true;
            showError = false;
            successMessage = "Module permissions saved successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = "Error saving permissions: " + ex.Message;
            showError = true;
            showSuccess = false;
        }
    }

    private async Task SavePagePermissions()
    {
        if (selectedRole == null) return;

        try
        {
            // Get existing page permissions for this role
            var existingPagePermissions = await DbContext.RolePagePermissions
                .Where(rpp => rpp.RoleId == selectedRole.Id)
                .ToListAsync();

            // Remove all existing page permissions for this role
            DbContext.RolePagePermissions.RemoveRange(existingPagePermissions);

            // Add new page permissions
            var newPagePermissions = rolePagePermissions
                .Where(rpp => rpp.CanRead || rpp.CanWrite || rpp.CanCreate || rpp.CanDelete || rpp.CanNavigate)
                .ToList();

            if (newPagePermissions.Any())
            {
                await DbContext.RolePagePermissions.AddRangeAsync(newPagePermissions);
            }

            await DbContext.SaveChangesAsync();
            
            ShowPagePermissionsModal = false;
            await LoadRoles();
            
            showSuccess = true;
            showError = false;
            successMessage = "Page permissions saved successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = "Error saving page permissions: " + ex.Message;
            showError = true;
            showSuccess = false;
        }
    }

    private async Task AssignRoleToUser()
    {
        if (selectedUser == null || string.IsNullOrEmpty(selectedRoleIdForUser)) return;

        try
        {
            var user = await DbContext.Users.FindAsync(selectedUser.Id);
            if (user != null)
            {
                user.RoleId = selectedRoleIdForUser;
                
                // Create user role assignment record
                var assignment = new UserRoleAssignment
                {
                    UserId = user.Id,
                    RoleId = selectedRoleIdForUser,
                    AssignedBy = LoginManager.CurrentUser?.Id ?? "system",
                    AssignedDate = DateTime.Now,
                    IsActive = true
                };
                
                await DbContext.UserRoleAssignments.AddAsync(assignment);
                await DbContext.SaveChangesAsync();
                
                ShowUserRoleModal = false;
                await LoadUsers();
                
                showSuccess = true;
                showError = false;
                successMessage = $"Role assigned to {user.UserName} successfully!";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error assigning role: " + ex.Message;
            showError = true;
            showSuccess = false;
        }
    }

    private RolePagePermission GetOrCreateRolePagePermission(int pagePermissionId)
    {
        var rolePagePerm = rolePagePermissions.FirstOrDefault(rpp => rpp.PagePermissionId == pagePermissionId);
        if (rolePagePerm == null && selectedRole != null)
        {
            rolePagePerm = new RolePagePermission 
            { 
                RoleId = selectedRole.Id, 
                PagePermissionId = pagePermissionId 
            };
            rolePagePermissions.Add(rolePagePerm);
        }
        return rolePagePerm!;
    }
}
